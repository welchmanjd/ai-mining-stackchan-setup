<Window x:Class="AiStackchanSetup.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="AIマイニングスタックチャン セットアップ" Height="900" Width="860"
        WindowStartupLocation="CenterScreen"
        Closing="Window_OnClosing">
    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Margin="0,0,0,12">
            <TextBlock Text="AIマイニングスタックチャン セットアップ" FontSize="20" FontWeight="SemiBold" />
            <TextBlock Text="知識ゼロでも迷わず進めるセットアップ" Foreground="#6B7280" />
            <TextBlock Text="{Binding StepIndicator, StringFormat=ステップ: {0}}" FontWeight="SemiBold" Margin="0,8,0,4" />
            <ProgressBar Height="8" Minimum="0" Maximum="100" Value="{Binding StepProgressPercent, Mode=OneWay}" Foreground="#2563EB" Background="#E5E7EB" />
            <TextBlock Text="{Binding InputStatusText}" FontSize="12" Foreground="#6B7280" Margin="0,6,0,0" />
        </StackPanel>

        <Grid Grid.Row="1">
            <Border BorderBrush="#E5E7EB" BorderThickness="1" CornerRadius="8" Padding="20">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <StackPanel>
                        <TextBlock Text="{Binding StepTitle}" FontSize="18" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding StepDescription}" FontSize="12" Foreground="#6B7280" Margin="0,4,0,0" TextWrapping="Wrap" />
                    </StackPanel>

                    <ScrollViewer x:Name="MainStepScrollViewer"
                                  Grid.Row="1"
                                  Margin="0,16,0,0"
                                  VerticalScrollBarVisibility="Auto"
                                  CanContentScroll="False"
                                  PanningMode="VerticalFirst">
                        <Grid>
                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=1}">
                                <Grid MinHeight="{Binding ActualHeight, ElementName=MainStepScrollViewer}">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <StackPanel Grid.Row="0">
                                        <TextBlock Text="USBでM5Stack Core2を接続してください。" Margin="0,0,0,8" />
                                        <ComboBox ItemsSource="{Binding Ports}"
                                                  SelectedItem="{Binding SelectedPort}"
                                                  DisplayMemberPath="DisplayName"
                                                  IsEnabled="{Binding IsManualPortSelection}"
                                                  Visibility="{Binding IsManualPortSelection, Converter={StaticResource BoolToVisibility}}"
                                                  Margin="0,0,0,8" />
                                        <TextBlock Text="{Binding Step1Help}" Foreground="#B45309" Margin="0,0,0,8" />
                                    </StackPanel>

                                    <Expander Grid.Row="2" Header="詳細 (Advanced)" IsExpanded="{Binding IsAdvancedPanelOpen}">
                                        <StackPanel>
                                            <CheckBox Content="手動で接続先を選ぶ（COMポート）" IsChecked="{Binding IsManualPortSelection}" Margin="0,0,0,6" />
                                            <TextBlock Text="見つからない場合は、USBケーブル/ポート/ドライバを確認してください。" />
                                            <TextBlock Text="よくある原因: (1) ドライバ未導入 (2) 充電専用ケーブル (3) 他アプリが接続先（COMポート）を使用中"
                                                       Foreground="#6B7280"
                                                       TextWrapping="Wrap" />
                                        </StackPanel>
                                    </Expander>
                                </Grid>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=2}">
                                <Grid MinHeight="{Binding ActualHeight, ElementName=MainStepScrollViewer}">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <StackPanel Grid.Row="0">
                                        <StackPanel Margin="0,0,0,8">
                                            <RadioButton Content="{Binding FlashOverwriteOptionText}" IsChecked="{Binding FlashModeOverwrite}" GroupName="FlashMode" Margin="0,0,0,4" />
                                            <RadioButton Content="{Binding FlashEraseOptionText}" IsChecked="{Binding FlashModeErase}" GroupName="FlashMode" Margin="0,0,0,4" />
                                            <RadioButton Content="書き込みをスキップして設定のみ行う"
                                                         IsChecked="{Binding FlashModeSkip}"
                                                         GroupName="FlashMode"
                                                         Visibility="{Binding ShowFlashSkipOption, Converter={StaticResource BoolToVisibility}}" />
                                        </StackPanel>
                                        <ProgressBar IsIndeterminate="True" Height="8" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibility}}" Margin="0,0,0,8" />
                                        <TextBlock Text="{Binding FlashStatus}" Foreground="#6B7280" Margin="0,0,0,8" />
                                        <Border Height="1" Background="#E5E7EB" Margin="0,0,0,10" />
                                        <TextBlock Text="{Binding FirmwarePath, StringFormat=ファイル: {0}}" Margin="0,0,0,4" />
                                        <TextBlock Text="{Binding FirmwareInfoText, StringFormat=書き込むFW: {0}}" FontSize="12" Foreground="#6B7280" Margin="0,0,0,8" />
                                        <TextBlock Text="{Binding CurrentFirmwareInfoText, StringFormat=現在動作中FW: {0}}" FontSize="12" Foreground="#6B7280" Margin="0,0,0,4" />
                                        <TextBlock Text="{Binding FirmwareCompareMessage}" FontSize="12" Foreground="#B45309" Margin="0,0,0,8" TextWrapping="Wrap" />
                                        <Border Height="1" Background="#E5E7EB" Margin="0,4,0,10" />
                                    </StackPanel>

                                    <Expander Grid.Row="2" Header="詳細 (Advanced)">
                                        <StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                                <TextBlock Text="Baud:" VerticalAlignment="Center" Margin="0,0,6,0" />
                                                <TextBox Width="120" Text="{Binding FlashBaud}" />
                                            </StackPanel>
                                            <Button Content="ファイルを選ぶ" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding BrowseFirmwareCommand}" Margin="0,0,0,6" />
                                            <TextBlock Text="書き込みログ" FontWeight="SemiBold" Margin="0,4,0,2" />
                                            <TextBlock Text="{Binding FlashLogPath}" FontSize="12" Foreground="#6B7280" TextWrapping="Wrap" Margin="0,0,0,6" />
                                            <Button Content="書き込みログを開く" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding OpenFlashLogCommand}" />
                                        </StackPanel>
                                    </Expander>
                                </Grid>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=3}">
                                <TextBlock Text="機能のON/OFFを設定します。" Margin="0,0,0,8" />
                                <TextBlock Text="{Binding DeviceStatusSummary, StringFormat=デバイス情報: {0}}" FontSize="12" Foreground="#6B7280" Margin="0,0,0,8" />
                                <GroupBox Header="機能のON/OFF" Margin="0,0,0,8">
                                    <StackPanel Margin="8,6,8,6">
                                        <CheckBox Content="wifi/通信を有効化" IsChecked="{Binding WifiEnabled}" Margin="0,0,0,4" />
                                        <CheckBox Content="マイニングを有効化" IsChecked="{Binding MiningEnabled}" IsEnabled="{Binding FeatureToggleChildrenEnabled}" Margin="0,0,0,4" />
                                        <CheckBox Content="AIを有効化" IsChecked="{Binding AiEnabled}" IsEnabled="{Binding FeatureToggleChildrenEnabled}" />
                                    </StackPanel>
                                </GroupBox>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=4}">
                                <TextBlock Text="wifiを設定します。" Margin="0,0,0,8" />
                                <Border Background="#FEF3C7" CornerRadius="6" Padding="8" Margin="0,0,0,8">
                                    <TextBlock Text="wifiは2.4GHzだけに対応しています。"
                                               Foreground="#92400E"
                                               TextWrapping="Wrap" />
                                </Border>
                                <StackPanel Margin="0,0,0,8">
                                    <TextBlock Text="wifi SSID" />
                                    <TextBox Text="{Binding ConfigWifiSsid}" />
                                </StackPanel>
                                <StackPanel Margin="0,0,0,8">
                                    <TextBlock Text="wifiパスワード" />
                                    <Grid Margin="0,0,0,4">
                                        <PasswordBox x:Name="WifiPasswordBox" PasswordChanged="WifiPasswordBox_OnPasswordChanged" IsEnabled="{Binding CanEditWifiPassword}">
                                            <PasswordBox.Style>
                                                <Style TargetType="PasswordBox" BasedOn="{StaticResource {x:Type PasswordBox}}">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ShowWifiPassword}" Value="True">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </PasswordBox.Style>
                                        </PasswordBox>
                                        <TextBox Text="{Binding ConfigWifiPassword, UpdateSourceTrigger=PropertyChanged}"
                                                 IsEnabled="{Binding CanEditWifiPassword}"
                                                 Visibility="{Binding ShowWifiPassword, Converter={StaticResource BoolToVisibility}}" />
                                    </Grid>
                                    <CheckBox Content="入力内容を表示"
                                              IsChecked="{Binding ShowWifiPassword}"
                                              IsEnabled="{Binding CanEditWifiPassword}"
                                              Margin="0,0,0,4" />
                                    <CheckBox Content="M5StackCore2内に保存されている情報を再利用"
                                              IsChecked="{Binding ReuseWifiPassword}"
                                              IsEnabled="{Binding CanReuseWifiPassword}"
                                              Visibility="{Binding CanReuseWifiPassword, Converter={StaticResource BoolToVisibility}}" />
                                    <TextBlock Text="パスワードの先頭または末尾にスペースがあります。意図した入力か確認してください。"
                                               Foreground="#B45309"
                                               FontSize="12"
                                               Margin="0,6,0,0"
                                               TextWrapping="Wrap"
                                               Visibility="{Binding ShowWifiPasswordSpaceWarning, Converter={StaticResource BoolToVisibility}}" />
                                    <Border Background="#EFF6FF" CornerRadius="6" Padding="8" Margin="0,8,0,0">
                                        <StackPanel>
                                            <TextBlock Text="入力したwifiパスワードは、ｽﾀｯｸﾁｬﾝをwifiにつなぐためにだけ使用します。"
                                                       Foreground="#1E3A8A"
                                                       TextWrapping="Wrap" />
                                            <TextBlock Text="サポート用ログには、wifiパスワードとAPIキー本体は含めません。"
                                                       Foreground="#1E3A8A"
                                                       Margin="0,4,0,0"
                                                       TextWrapping="Wrap" />
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=5}">
                                <Border Background="#EEF2FF"
                                        CornerRadius="6"
                                        Padding="8"
                                        Margin="0,0,0,8"
                                        Visibility="{Binding IsMiningDisabled, Converter={StaticResource BoolToVisibility}}">
                                    <TextBlock Text="マイニング機能がオフのため、空欄のまま進められます"
                                               Foreground="#1D4ED8"
                                               FontSize="15"
                                               FontWeight="SemiBold" />
                                </Border>
                                <Border BorderBrush="#D1D5DB" BorderThickness="1" CornerRadius="6" Padding="10"
                                        Background="#F9FAFB"
                                        IsEnabled="{Binding MiningEnabled}">
                                    <StackPanel>
                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="Duino-coin アカウント名" />
                                            <TextBox Text="{Binding DucoUser}" />
                                        </StackPanel>
                                        <Border Height="1" Background="#E5E7EB" Margin="0,10,0,12" />
                                        <TextBlock Text="通常は空欄のままで大丈夫です。" FontSize="12" Foreground="#6B7280" Margin="0,0,0,8" />
                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="Duino-coin マイナーキー（もしあれば）" />
                                            <Grid Margin="0,0,0,4">
                                                <PasswordBox x:Name="DucoMinerKeyBox" PasswordChanged="DucoMinerKeyBox_OnPasswordChanged" IsEnabled="{Binding CanEditDucoMinerKey}">
                                                    <PasswordBox.Style>
                                                        <Style TargetType="PasswordBox" BasedOn="{StaticResource {x:Type PasswordBox}}">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding ShowDucoMinerKey}" Value="True">
                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </PasswordBox.Style>
                                                </PasswordBox>
                                                <TextBox Text="{Binding DucoMinerKey, UpdateSourceTrigger=PropertyChanged}"
                                                         IsEnabled="{Binding CanEditDucoMinerKey}"
                                                         Visibility="{Binding ShowDucoMinerKey, Converter={StaticResource BoolToVisibility}}" />
                                            </Grid>
                                            <CheckBox Content="入力内容を表示"
                                                      IsChecked="{Binding ShowDucoMinerKey}"
                                                      IsEnabled="{Binding CanEditDucoMinerKey}"
                                                      Margin="0,0,0,4" />
                                            <CheckBox Content="M5StackCore2内に保存されている情報を再利用"
                                                      IsChecked="{Binding ReuseDucoMinerKey}"
                                                      IsEnabled="{Binding CanReuseDucoMinerKey}"
                                                      Visibility="{Binding CanReuseDucoMinerKey, Converter={StaticResource BoolToVisibility}}" />
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=6}">
                                <TextBlock Text="Azure Speechを設定します。" Margin="0,0,0,8" />
                                <StackPanel Margin="0,0,0,8">
                                    <TextBlock Text="リージョン" />
                                    <TextBox Text="{Binding AzureRegion}" />
                                </StackPanel>
                                <StackPanel Margin="0,0,0,8">
                                    <TextBlock Text="Azureキー" />
                                    <Grid Margin="0,0,0,4">
                                        <PasswordBox x:Name="AzureKeyBox" PasswordChanged="AzureKeyBox_OnPasswordChanged" IsEnabled="{Binding CanEditAzureKey}">
                                            <PasswordBox.Style>
                                                <Style TargetType="PasswordBox" BasedOn="{StaticResource {x:Type PasswordBox}}">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ShowAzureKey}" Value="True">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </PasswordBox.Style>
                                        </PasswordBox>
                                        <TextBox Text="{Binding AzureKey, UpdateSourceTrigger=PropertyChanged}"
                                                 IsEnabled="{Binding CanEditAzureKey}"
                                                 Visibility="{Binding ShowAzureKey, Converter={StaticResource BoolToVisibility}}" />
                                    </Grid>
                                    <CheckBox Content="入力内容を表示"
                                              IsChecked="{Binding ShowAzureKey}"
                                              IsEnabled="{Binding CanEditAzureKey}"
                                              Margin="0,0,0,4" />
                                    <CheckBox Content="M5StackCore2内に保存されている情報を再利用"
                                              IsChecked="{Binding ReuseAzureKey}"
                                              IsEnabled="{Binding CanReuseAzureKey}"
                                              Visibility="{Binding CanReuseAzureKey, Converter={StaticResource BoolToVisibility}}" />
                                    <TextBlock Text="入力したAPIキーは、動作確認とｽﾀｯｸﾁｬﾝの設定にだけ使用します。"
                                               FontSize="12"
                                               Foreground="#1E3A8A"
                                               Margin="0,6,0,0"
                                               TextWrapping="Wrap" />
                                    <TextBlock Text="サポート用ログには、wifiパスワードとAPIキー本体は含めません。"
                                               FontSize="12"
                                               Foreground="#1E3A8A"
                                               Margin="0,2,0,0"
                                               TextWrapping="Wrap" />
                                </StackPanel>

                                <Border Height="1" Background="#E5E7EB" Margin="0,10,0,12" />
                                <TextBlock Text="通常は空欄のままで大丈夫です。" FontSize="12" Foreground="#6B7280" Margin="0,0,0,8" />
                                <StackPanel Margin="0,0,0,8">
                                    <TextBlock Text="カスタムサブドメイン（もしあれば）" />
                                    <TextBox Text="{Binding AzureCustomSubdomain}" />
                                    <TextBlock Text="例: mining-stackchan-tts（http:// は不要、末尾 / は不要。mining-stackchan-tts.cognitiveservices.azure.com も可）"
                                               FontSize="12"
                                               Foreground="#6B7280"
                                               Margin="0,4,0,0"
                                               TextWrapping="Wrap" />
                                </StackPanel>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=7}">
                                <TextBlock Text="OpenAI APIキーを設定します。" Margin="0,0,0,8" />
                                <StackPanel Margin="0,0,0,8">
                                    <TextBlock Text="OpenAI APIキー" />
                                    <Grid Margin="0,0,0,4">
                                        <PasswordBox x:Name="OpenAiKeyBox" PasswordChanged="OpenAiKeyBox_OnPasswordChanged" IsEnabled="{Binding CanEditOpenAiKey}">
                                            <PasswordBox.Style>
                                                <Style TargetType="PasswordBox" BasedOn="{StaticResource {x:Type PasswordBox}}">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ShowOpenAiKey}" Value="True">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </PasswordBox.Style>
                                        </PasswordBox>
                                        <TextBox Text="{Binding ConfigOpenAiKey, UpdateSourceTrigger=PropertyChanged}"
                                                 IsEnabled="{Binding CanEditOpenAiKey}"
                                                 Visibility="{Binding ShowOpenAiKey, Converter={StaticResource BoolToVisibility}}" />
                                    </Grid>
                                    <CheckBox Content="入力内容を表示"
                                              IsChecked="{Binding ShowOpenAiKey}"
                                              IsEnabled="{Binding CanEditOpenAiKey}"
                                              Margin="0,0,0,4" />
                                    <CheckBox Content="M5StackCore2内に保存されている情報を再利用"
                                              IsChecked="{Binding ReuseOpenAiKey}"
                                              IsEnabled="{Binding CanReuseOpenAiKey}"
                                              Visibility="{Binding CanReuseOpenAiKey, Converter={StaticResource BoolToVisibility}}" />
                                    <Border Background="#EFF6FF" CornerRadius="6" Padding="8" Margin="0,8,0,0">
                                        <StackPanel>
                                            <TextBlock Text="入力したAPIキーは、動作確認とｽﾀｯｸﾁｬﾝの設定にだけ使用します。"
                                                       Foreground="#1E3A8A"
                                                       TextWrapping="Wrap" />
                                            <TextBlock Text="サポート用ログには、wifiパスワードとAPIキー本体は含めません。"
                                                       Foreground="#1E3A8A"
                                                       Margin="0,4,0,0"
                                                       TextWrapping="Wrap" />
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=8}">
                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="初期プロンプト (OpenAI instructions)" />
                                            <TextBlock Text="このテキストは、対話AIの最初の振る舞いを決める設定です。必要なければ既定のままで大丈夫です。" FontSize="12" Foreground="#6B7280" Margin="0,2,0,4" TextWrapping="Wrap" />
                                            <TextBox Text="{Binding ConfigOpenAiInstructions}" AcceptsReturn="True" TextWrapping="Wrap" MinHeight="72" />
                                        </StackPanel>

                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="画面スリープ秒数" />
                                            <TextBox Text="{Binding DisplaySleepSecondsText}" />
                                        </StackPanel>

                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="スピーカー音量（0-255）" />
                                            <TextBlock Text="入力値をそのまま音量に反映します。" FontSize="12" Foreground="#6B7280" Margin="0,2,0,4" TextWrapping="Wrap" />
                                            <Slider Minimum="0"
                                                    Maximum="255"
                                                    TickFrequency="5"
                                                    IsSnapToTickEnabled="False"
                                                    Value="{Binding SpeakerVolumeRaw}" />
                                            <TextBlock Text="{Binding SpeakerVolumeText, StringFormat=現在の音量: {0} / 255}" FontSize="12" Foreground="#6B7280" />
                                        </StackPanel>

                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="マイニングが進んだ時のセリフ" />
                                            <TextBox Text="{Binding ShareAcceptedText}" />
                                        </StackPanel>

                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="スタックチャン画面移動時のセリフ" />
                                            <TextBox Text="{Binding AttentionText}" />
                                        </StackPanel>

                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="ボタンBを押した時の返事" />
                                            <TextBox Text="{Binding HelloText}" />
                                        </StackPanel>

                                        <TextBlock Text="トラブル時の調査用です。不要なら有効にしなくて大丈夫です。" FontSize="12" Foreground="#6B7280" Margin="0,2,0,4" TextWrapping="Wrap" />
                                        <CheckBox Content="（任意）書き込み後に起動ログを60秒取得する" IsChecked="{Binding CaptureSerialLogAfterReboot}"
                                                  Margin="0,0,0,8" />

                                        <StackPanel Margin="0,0,0,8">
                                            <TextBlock Text="OpenAIモデル" />
                                            <ComboBox ItemsSource="{Binding OpenAiModelOptions}"
                                                      SelectedValuePath="."
                                                      SelectedValue="{Binding ConfigOpenAiModel, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      HorizontalAlignment="Left"
                                                      MinWidth="140"
                                                      IsEditable="False"
                                                      IsTextSearchEnabled="True" />
                                        </StackPanel>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=9}">
                                        <TextBlock Text="APIキー確認と設定保存を実行します。" Margin="0,0,0,8" />
                                        <TextBlock Text="「設定保存」を押すと、有効確認のあと設定を保存して再起動します。" FontSize="12" Foreground="#6B7280" Margin="0,0,0,10" />

                                        <GroupBox Header="APIキー事前確認（任意）" Margin="0,0,0,10">
                                            <StackPanel Margin="8,6,8,6">
                                                <TextBlock Text="{Binding ApiValidationGuideText}" Foreground="#6B7280" Margin="0,0,0,8" />
                                                <Button Content="APIキーの有効確認を実行" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding ValidateApiKeysCommand}" IsEnabled="{Binding CanRunApiValidation}" Margin="0,0,0,8" />
                                                <Border Background="{Binding ApiTestSummaryBackground}" CornerRadius="6" Padding="8" Margin="0,0,0,6">
                                                    <TextBlock Text="{Binding ApiTestSummary, StringFormat=OpenAI: {0}}" Foreground="{Binding ApiTestSummaryBrush}" />
                                                </Border>
                                                <Border Background="{Binding AzureTestSummaryBackground}" CornerRadius="6" Padding="8">
                                                    <TextBlock Text="{Binding AzureTestSummary, StringFormat=Azure: {0}}" Foreground="{Binding AzureTestSummaryBrush}" />
                                                </Border>
                                            </StackPanel>
                                        </GroupBox>
                            </StackPanel>

                            <StackPanel Visibility="{Binding Step, Converter={StaticResource StepToVisibilityConverter}, ConverterParameter=10}">
                                <TextBlock Text="セットアップ完了" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,8" />
                                <TextBlock Text="AIマイニングスタックチャンの設定が完了しました。" Margin="0,0,0,6" />
                                <TextBlock Text="必要ならサポート用ログを保存してください。" Margin="0,0,0,12" />
                                <StackPanel Orientation="Horizontal">
                                    <Button Content="ログフォルダを開く" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding OpenLogFolderCommand}" />
                                </StackPanel>
                            </StackPanel>
                        </Grid>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <Grid Grid.Row="2" Margin="0,16,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel MinHeight="120">
                <TextBlock Text="{Binding StatusMessage}" Foreground="#6B7280" TextWrapping="Wrap" />
                <TextBlock Text="{Binding StatusAssistMessage}" Foreground="#6B7280" Margin="0,4,0,0" TextWrapping="Wrap" />
                <TextBlock Text="{Binding ErrorMessage}" Foreground="#B91C1C" Margin="0,4,0,0" TextWrapping="Wrap" />
                <Border Background="#FFF7ED"
                        BorderBrush="#FDBA74"
                        BorderThickness="1"
                        CornerRadius="6"
                        Padding="8"
                        Margin="0,8,0,0"
                        Visibility="{Binding ShowFailureActions, Converter={StaticResource BoolToVisibility}}">
                    <StackPanel>
                        <TextBlock Text="{Binding StepGuidanceMessage}"
                                   Foreground="#9A3412"
                                   Margin="0,0,0,8"
                                   TextWrapping="Wrap" />
                        <WrapPanel>
                            <Button Content="もう一度ためす"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{Binding PrimaryCommand}"
                                    IsEnabled="{Binding CanRetryCurrentStep}"
                                    Visibility="{Binding CanRetryCurrentStep, Converter={StaticResource BoolToVisibility}}"
                                    Margin="0,0,8,8" />
                            <Button Content="サポート用ログを作成"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{Binding CreateSupportPackCommand}"
                                    Margin="0,0,8,8" />
                            <Button Content="終了"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{Binding CloseCommand}"
                                    Margin="0,0,8,8" />
                        </WrapPanel>
                    </StackPanel>
                </Border>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Content="中止" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding CancelCommand}" IsEnabled="{Binding CanCancel}" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibility}}" Margin="0,0,12,0" />
                <Button Content="{Binding BackButtonText}" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding BackCommand}" Visibility="{Binding IsNotFirstStep, Converter={StaticResource BoolToVisibility}}" Margin="0,0,12,0" />
                <Button Content="{Binding PrimaryButtonText}" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding PrimaryCommand}" IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}" />
            </StackPanel>
        </Grid>
    </Grid>
</Window>


